name: Deploy ItemManagement (Compose bundle -> EC2)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

env:
  APP_ROOT: /var/www/itemmanagement
  PROJECT_NAME: itemmanagement
  API_HOST_PORT: "8082"
  UI_HOST_PORT: "8088"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create deploy bundle (deploy.tgz)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf deploy
          mkdir -p deploy

          cp docker-compose.yml deploy/
          cp -R ItemManagement.Api deploy/
          cp -R itemmanagement-ui deploy/
          cp -R DB deploy/ || true

          tar -czf deploy.tgz -C deploy .
          ls -lah deploy.tgz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-tgz
          path: deploy.tgz
          if-no-files-found: error

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-tgz

      - name: Setup SSH (safe + strict)
        shell: bash
        env:
          EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          if [ -z "${EC2_SSH_PRIVATE_KEY:-}" ]; then
            echo "ERROR: EC2_SSH_PRIVATE_KEY secret is empty."
            exit 1
          fi

          printf "%s" "$EC2_SSH_PRIVATE_KEY" > ~/.ssh/id_key
          tr -d '\r' < ~/.ssh/id_key > ~/.ssh/id_key.clean && mv ~/.ssh/id_key.clean ~/.ssh/id_key
          chmod 600 ~/.ssh/id_key

          timeout 10 bash -c "</dev/tcp/$EC2_HOST/22" >/dev/null 2>&1 || (echo "ERROR: Port 22 not reachable" && exit 1)
          ssh-keyscan -p 22 -T 10 -H "$EC2_HOST" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

          ssh -i ~/.ssh/id_key -o BatchMode=yes -o StrictHostKeyChecking=yes \
            "${{ secrets.EC2_USER }}@$EC2_HOST" "echo SSH_OK"

      - name: Upload deploy.tgz to EC2
        shell: bash
        run: |
          set -euo pipefail
          scp -i ~/.ssh/id_key -o StrictHostKeyChecking=yes \
            deploy.tgz "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/deploy.tgz"

      - name: Deploy on EC2 (releases + shared env + compose up)
        shell: bash
        env:
          SA_PASSWORD: ${{ secrets.SA_PASSWORD }}
          SQL_DB: ${{ secrets.SQL_DB }}
          APP_ROOT: ${{ env.APP_ROOT }}
          PROJECT_NAME: ${{ env.PROJECT_NAME }}
          API_HOST_PORT: ${{ env.API_HOST_PORT }}
          UI_HOST_PORT: ${{ env.UI_HOST_PORT }}
        run: |
          set -euo pipefail

          ssh -i ~/.ssh/id_key -o StrictHostKeyChecking=yes \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" \
            "APP_ROOT='$APP_ROOT' PROJECT_NAME='$PROJECT_NAME' API_HOST_PORT='$API_HOST_PORT' UI_HOST_PORT='$UI_HOST_PORT' SA_PASSWORD='$SA_PASSWORD' SQL_DB='$SQL_DB' bash -s" << 'REMOTE'
              set -euo pipefail

              TS="$(date +%Y%m%d%H%M%S)"
              RELEASE_DIR="$APP_ROOT/releases/$TS"
              SHARED_DIR="$APP_ROOT/shared"

              sudo mkdir -p "$APP_ROOT/releases" "$RELEASE_DIR" "$SHARED_DIR"

              if ! sudo docker --version >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y docker.io
                sudo systemctl enable docker
                sudo systemctl start docker
                sudo usermod -aG docker ubuntu || true
              fi

              if ! sudo docker compose version >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y docker-compose-plugin
              fi

              # Create shared .env once (no inner heredoc - avoids YAML issues)
              if [ ! -f "$SHARED_DIR/.env" ]; then
                sudo bash -c "printf '%s\n' \
                  'SA_PASSWORD=$SA_PASSWORD' \
                  'SQL_DB=$SQL_DB' \
                  'API_PORT=$API_HOST_PORT' \
                  'WEB_PORT=$UI_HOST_PORT' \
                  > '$SHARED_DIR/.env'"
                sudo chmod 600 "$SHARED_DIR/.env"
              fi

              sudo tar -xzf /tmp/deploy.tgz -C "$RELEASE_DIR"
              sudo rm -f /tmp/deploy.tgz

              sudo ln -sfn "$SHARED_DIR/.env" "$RELEASE_DIR/.env"

              cd "$RELEASE_DIR"
              sudo docker compose -p "$PROJECT_NAME" up -d --build
              sudo docker compose -p "$PROJECT_NAME" ps

              sudo ln -sfn "$RELEASE_DIR" "$APP_ROOT/current"

              curl -fsS "http://localhost:${API_HOST_PORT}/api/health" >/dev/null
              curl -fsS "http://localhost:${UI_HOST_PORT}/" >/dev/null

              echo "DEPLOY_OK: $RELEASE_DIR"
REMOTE

      - name: Show final URLs
        shell: bash
        run: |
          echo "UI:  http://${{ secrets.EC2_HOST }}:${{ env.UI_HOST_PORT }}"
          echo "API: http://${{ secrets.EC2_HOST }}:${{ env.API_HOST_PORT }}/api/health"
