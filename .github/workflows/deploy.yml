name: Deploy to EC2 (Docker Compose)

on:
  push:
    branches: ["main", "master"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create deploy.tgz (tracked files only)
        shell: bash
        run: |
          set -euo pipefail
          git ls-files -z | tar --null -T - -czf deploy.tgz
          ls -lah deploy.tgz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-tgz
          path: deploy.tgz
          if-no-files-found: error

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-tgz
          path: .

      - name: Setup SSH (robust + debug)
        shell: bash
        env:
          EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          set -euo pipefail

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          if [ -z "${EC2_SSH_PRIVATE_KEY:-}" ]; then
            echo "ERROR: EC2_SSH_PRIVATE_KEY is empty"
            exit 1
          fi

          # secret is BASE64 of the PRIVATE KEY bytes
          printf "%s" "$EC2_SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/id_rsa
          tr -d '\r' < ~/.ssh/id_rsa > ~/.ssh/id_rsa.clean && mv ~/.ssh/id_rsa.clean ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          ssh-keyscan -p 22 -T 10 -H "$EC2_HOST" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

          echo "USER=$EC2_USER HOST=$EC2_HOST"

          echo "Runner SSH key fingerprint (SHA256):"
          ssh-keygen -y -f ~/.ssh/id_rsa | ssh-keygen -lf -

          ssh -i ~/.ssh/id_rsa -o BatchMode=yes -o StrictHostKeyChecking=yes \
            "$EC2_USER@$EC2_HOST" "echo SSH_OK"

      - name: Create app.env (runner)
        shell: bash
        env:
          SA_PASSWORD: ${{ secrets.SA_PASSWORD }}
          SQL_DB: ${{ secrets.SQL_DB }}
          JWT_KEY: ${{ secrets.JWT_KEY }}
        run: |
          set -euo pipefail
          umask 077

          # docker-compose uses ${SA_PASSWORD}, so write SA_PASSWORD
          printf "SA_PASSWORD=%s\nSQL_DB=%s\nJWT_KEY=%s\n" \
            "$SA_PASSWORD" "$SQL_DB" "$JWT_KEY" > app.env

          wc -c app.env

      - name: Upload deploy.tgz + app.env to EC2
        shell: bash
        run: |
          set -euo pipefail
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes \
            ./deploy.tgz ./app.env \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/"

      - name: Deploy on EC2 (no heredoc)
        shell: bash
        run: |
          set -euo pipefail

          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" \
            "bash -lc 'set -euo pipefail
              APP_NAME=role-item-system
              APP_ROOT=/var/www/roleitems
              RELEASES_DIR=\$APP_ROOT/releases
              SHARED_DIR=\$APP_ROOT/shared
              COMPOSE_FILE=docker-compose.yml
              ENV_FILE=.env
              KEEP_RELEASES=5

              TS=\$(date +%Y%m%d%H%M%S)
              NEW_RELEASE=\$RELEASES_DIR/\$TS

              echo \"==> Deploying \$APP_NAME\"
              echo \"==> New release: \$NEW_RELEASE\"

              sudo mkdir -p \"\$NEW_RELEASE\" \"\$SHARED_DIR\"

              sudo tar -xzf /tmp/deploy.tgz -C \"\$NEW_RELEASE\"
              sudo rm -f /tmp/deploy.tgz

              sudo mv /tmp/app.env \"\$SHARED_DIR/\$ENV_FILE\"
              sudo chmod 600 \"\$SHARED_DIR/\$ENV_FILE\"

              sudo ln -sfn \"\$SHARED_DIR/\$ENV_FILE\" \"\$NEW_RELEASE/\$ENV_FILE\"
              sudo ln -sfn \"\$NEW_RELEASE\" \"\$APP_ROOT/current\"

              cd \"\$APP_ROOT/current\"

              sudo docker compose -f \"\$COMPOSE_FILE\" --env-file \"\$ENV_FILE\" up -d --build --remove-orphans

              sudo bash -c \"ls -1dt '\$RELEASES_DIR'/* | tail -n +\$((KEEP_RELEASES+1)) | xargs -r rm -rf\"

              echo \"==> Done. Current -> \$(readlink -f '\$APP_ROOT/current')\"
            '"
