      - name: Prepare SSH (diagnostics)
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p ~/.ssh

          echo "Checking secrets presence..."
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "ERROR: EC2_HOST secret is empty or missing"
            exit 1
          fi
          if [ -z "${{ secrets.EC2_USER }}" ]; then
            echo "ERROR: EC2_USER secret is empty or missing"
            exit 1
          fi
          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "ERROR: EC2_SSH_KEY secret is empty or missing"
            exit 1
          fi

          echo "Writing SSH key..."
          printf '%s' "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "Key file size:"
          wc -c ~/.ssh/id_rsa

          echo "Testing key format (should say: 'RSA' or 'ED25519' or similar)..."
          ssh-keygen -lf ~/.ssh/id_rsa || (echo "ERROR: private key format is invalid" && exit 1)

          echo "Running ssh-keyscan to ${{ secrets.EC2_HOST }}..."
          ssh-keyscan -T 10 -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts || (echo "ERROR: ssh-keyscan failed (wrong IP or port 22 blocked)" && exit 1)

          echo "Prepare SSH completed."
